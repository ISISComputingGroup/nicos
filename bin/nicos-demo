#!/bin/sh
if [ ! "x$1" = "x-c" ]; then
	echo -n 'Compiling in-place... '
	make inplace > /dev/null
	echo 'done.'
fi
echo -n 'Starting NICOS demo system, please wait: '
bin/nicos-cache >/dev/null &
CACHEPID=$!
echo -n 'cache '
sleep 2
bin/nicos-watchdog >/dev/null &
WATCHDOGPID=$!
echo -n 'watchdog '
sleep 0.1
bin/nicos-elog >/dev/null &
ELOGPID=$!
echo -n 'elog '
sleep 0.1
bin/nicos-poller >/dev/null &
POLLERPID=$!
echo -n 'poller '
sleep 0.1
if [ "x$1" = "x-N" ]; then
	shift
else
	bin/nicos-monitor >/dev/null &
	MONIPID=$!
	echo -n 'monitor '
	sleep 0.1
fi
if [ ! "x$1" = "x-t" ]; then
	bin/nicos-daemon >/dev/null &
	DAEMONPID=$!
	echo -n 'daemon'
	sleep 1
	echo '.'
	echo 'Services started, starting GUI.'
	bin/nicos-gui guest@localhost '' "$@"
else
	echo
	echo 'Services started, starting console.'
	bin/nicos-console
fi
kill -2 $MONIPID 2>/dev/null
if [ ! -z "$DAEMONPID" ]; then kill $DAEMONPID; fi
sleep 0.5
kill $POLLERPID
kill $ELOGPID
kill $WATCHDOGPID
kill $CACHEPID
echo 'NICOS demo finished.'
