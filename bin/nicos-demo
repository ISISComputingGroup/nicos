#!/bin/sh
CONSOLE=0
NOCLIENT=0
NOMONI=0
NOCOMPILE=0
GUICONFIG=""
GUIUSER="guest@localhost"

while getopts tNnCc:u: name; do
    case "$name" in
        t)
          CONSOLE=1;;
        n)
          NOCLIENT=1;;
        N)
          NOMONI=1;;
        C)
          NOCOMPILE=1;;
        c)
          GUICONFIG="-c $OPTARG";;
        u)
          GUIUSER="$OPTARG";;
       -)
         break;;
    esac
done
shift $(($OPTIND - 1))

if [ "$NOCOMPILE" = "0" ]; then
    echo -n 'Compiling in-place... '
    make inplace > /dev/null
    echo 'done.'
fi
echo -n 'Starting NICOS demo system, please wait: '
bin/nicos-cache >/dev/null &
CACHEPID=$!
echo -n 'cache '
sleep 2
bin/nicos-watchdog >/dev/null &
WATCHDOGPID=$!
echo -n 'watchdog '
sleep 0.1
bin/nicos-elog >/dev/null &
ELOGPID=$!
echo -n 'elog '
sleep 0.1
bin/nicos-poller >/dev/null &
POLLERPID=$!
echo -n 'poller '
sleep 0.1
if [ "$NOMONI" = "0" ]; then
    bin/nicos-monitor >/dev/null &
    MONIPID=$!
    echo -n 'monitor '
    sleep 0.1
fi
if [ "$CONSOLE" = "1" ]; then
    echo
    echo 'Services started, starting console.'
    bin/nicos-console
else
    bin/nicos-daemon >/dev/null &
    DAEMONPID=$!
    echo -n 'daemon'
    sleep 1
    echo '.'
    if [ "$NOCLIENT" = "0" ]; then
        echo 'Services started, starting GUI.'
        bin/nicos-gui $GUIUSER '' $GUICONFIG "$@"
    else
        echo 'Services started, press Enter to stop them.'
        read dummy
    fi
fi
kill -2 $MONIPID 2>/dev/null
if [ ! -z "$DAEMONPID" ]; then kill $DAEMONPID; fi
sleep 0.5
kill $POLLERPID
kill $ELOGPID
kill $WATCHDOGPID
kill $CACHEPID
echo 'NICOS demo finished.'
