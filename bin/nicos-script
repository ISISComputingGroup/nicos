#!/usr/bin/env python

import sys, os
from os import path
thisfile = path.abspath(__file__)
while path.islink(thisfile):
    thisfile = path.join(path.dirname(thisfile), os.readlink(thisfile))
sys.path.insert(0, path.normpath(path.dirname(thisfile) + '/../lib'))

import optparse

parser = optparse.OptionParser()
parser.add_option('-M', '--maintenance', dest='mode', const='maintenance',
                  action='store_const', default='slave',
                  help='start in maintenance mode')
parser.add_option('-A', '--appname', dest='appname', default='script',
                  help='application name (base name for log files)')
opts, args = parser.parse_args()

if len(args) == 1:
    setup, script = 'startup', args[0]
elif len(args) >= 2:
    setup, script = args[:2]
else:
    raise SystemExit('Usage: nicos-script [setupname] filename')

setup = setup.split(',')
if path.isfile(script):
    script_text = open(script, 'U').read()
else:
    script_text = script

from nicos.core.sessions.simple import ScriptSession
ScriptSession.run(setup, script_text, mode=opts.mode, appname=opts.appname)
