#!/usr/bin/env python

import argparse
import signal
import sys

from os import path

sys.path.insert(0, path.dirname(path.dirname(path.realpath(__file__))))


parser = argparse.ArgumentParser()
parser.add_argument('-M', '--maintenance', dest='mode', const='maintenance',
                    action='store_const', default='slave',
                    help='start in maintenance mode')
parser.add_argument('-A', '--appname', dest='appname', default='script',
                    help='application name (base name for log files)')
parser.add_argument('-S', '--stop-after', dest='stop', default=0, type=int,
                    help='forcibly stop after SEC seconds', metavar='SEC')
parser.add_argument('args', nargs=argparse.ONE_OR_MORE,
                    help='[setupname] file_or_code')

opts = parser.parse_args()

if len(opts.args) == 1:
    setup, script = 'startup', opts.args[0]
elif len(opts.args) >= 2:
    setup, script = opts.args[:2]

setup = setup.split(',')
if path.isfile(script):
    script_text = open(script, 'U').read()
else:
    script_text = script

if opts.stop:
    signal.alarm(opts.stop)

from nicos.core.sessions.simple import ScriptSession
ScriptSession.run(setup, script_text, mode=opts.mode, appname=opts.appname)
