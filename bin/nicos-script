#!/usr/bin/env python

import sys
from os import path
sys.path.insert(0, path.dirname(path.dirname(path.realpath(__file__))))

import signal
import optparse

parser = optparse.OptionParser()
parser.add_option('-M', '--maintenance', dest='mode', const='maintenance',
                  action='store_const', default='slave',
                  help='start in maintenance mode')
parser.add_option('-A', '--appname', dest='appname', default='script',
                  help='application name (base name for log files)')
parser.add_option('-S', '--stop-after', dest='stop', default=0, type=int,
                  help='forcibly stop after SEC seconds', metavar='SEC')
opts, args = parser.parse_args()

if len(args) == 1:
    setup, script = 'startup', args[0]
elif len(args) >= 2:
    setup, script = args[:2]
else:
    raise SystemExit('Usage: nicos-script [options] [setupnames] file_or_code')

setup = setup.split(',')
if path.isfile(script):
    script_text = open(script, 'U').read()
else:
    script_text = script

if opts.stop:
    signal.alarm(opts.stop)

from nicos.core.sessions.simple import ScriptSession
ScriptSession.run(setup, script_text, mode=opts.mode, appname=opts.appname)
