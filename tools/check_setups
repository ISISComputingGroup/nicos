#!/usr/bin/env python

import os
import sys
import traceback
from os import path

SETUP_GROUPS = set([
    'basic', 'optional', 'lowlevel', 'simulated', 'special'
])

devs_seen = {}

def check_setupfile(filename):
    namespace = {'device': lambda c, **kw: (c, kw)}
    try:
        execfile(filename, namespace)
    except SyntaxError, e:
        print '%s ... not ok' % (e.filename, )
        print 'SyntaxError: %s' % (e.msg, )
        print ' line %d : %s' % (e.lineno, e.text, )
        return False
    except Exception, e:
        print '%s ... not ok' % (filename, )
        formatted_lines = traceback.format_exc().splitlines()
        print formatted_lines[-3]
        print formatted_lines[-1]
        print formatted_lines[-2]
        return False
    print '%s ... syntax ok' % (filename, )
    group = namespace.get('group', 'optional')
    if group not in SETUP_GROUPS:
        print '%s warning: invalid group %r' % (filename, group)
    description = namespace.get('description', None)
    if description is None and group in ('basic', 'optional'):
        print '%s warning: missing user-friendly description' % (filename, )
    if group != 'special':
        devs = namespace.get('devices', {})
        for devname in devs:
            if devname in devs_seen:
                print '%s warning: device name %s duplicate: also in %s' % \
                    (filename, devname, devs_seen[devname])
            else:
                devs_seen[devname] = filename
    return True

ret = True
for p in sys.argv[1:]:
    if path.isdir(p):
        for root, _dirs, files in os.walk(p):
            for f in files:
                if f.endswith('.py'):
                    ret &= check_setupfile(path.join(root, f))
    elif path.isfile(p):
        ret &= check_setupfile(p)

sys.exit(not ret)
