// *****************************************************************************
// NICOS-NG, the Networked Instrument Control System of the FRM-II
// Copyright (c) 2009-2011 by the NICOS-NG contributors (see AUTHORS)
//
// This program is free software; you can redistribute it and/or modify it under
// the terms of the GNU General Public License as published by the Free Software
// Foundation; either version 2 of the License, or (at your option) any later
// version.
//
// This program is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
// FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
// details.
//
// You should have received a copy of the GNU General Public License along with
// this program; if not, write to the Free Software Foundation, Inc.,
// 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
//
// Module authors:
//   Tobias Weber <tweber@frm2.tum.de>
//
// *****************************************************************************
// Klassen zum Laden und Verarbeiten von Tof- & Pad-Dateien

#ifndef __TOFLOADER__
#define __TOFLOADER__

#include "globals.h"
#include "roi.h"

class TmpImage;
class TmpGraph;
class TofImage;
class PadImage;

/*
 * minimal interface for images
 */
class BasicImage
{
	public:
		virtual int GetWidth() const = 0;
		virtual int GetHeight() const = 0;

		virtual double GetDoubleData(int iX, int iY) const = 0;
		virtual unsigned int GetIntData(int iX, int iY) const = 0;

		virtual int GetIntMin() const = 0;
		virtual int GetIntMax() const = 0;
		virtual double GetDoubleMin() const = 0;
		virtual double GetDoubleMax() const = 0;
};


/*
 * PAD
 * container representing a PAD image
 * (corresponds to the "IMAGE" measurement type in the server & HardwareLib)
 */
class PadImage : public BasicImage
{
	friend class TmpImage;

	protected:
		// actual data
		unsigned int *m_puiDaten;

		// lower & upper bound values
		int m_iMin, m_iMax;

		// PAD data stored in external memory which needs no management,
		// i.e. allocation & freeing?
		bool m_bExternalMem;

		PadConfig m_config;

		Roi m_roi;
		bool m_bUseRoi;

		// clean up
		void Clear(void);

	public:
		// create PAD from file (or empty PAD otherwise)
		PadImage(const char *pcFileName=NULL, bool bExternalMem=false,
				 const PadConfig* conf=0);

		// create PAD from other PAD
		PadImage(const PadImage& pad);

		virtual ~PadImage();

		virtual int GetWidth() const;
		virtual int GetHeight() const;

		// set pointer to external memory (if bExternalMem==true)
		void SetExternalMem(void* pvDaten);

		// size (in ints) of PAD image
		int GetPadSize() const;

		int LoadFile(const char *pcFileName);
		int SaveFile(const char *pcFileName);

		// load PAD from memory
		// uiBufLen: # of ints (NOT # of bytes)
		int LoadMem(const unsigned int *puiBuf, unsigned int uiBufLen);

		// calculate lower & upper bound values
		void UpdateRange();

		virtual int GetIntMin() const;
		virtual int GetIntMax() const;
		virtual double GetDoubleMin() const;
		virtual double GetDoubleMax() const;

		// print PAD as text
		void Print(const char* pcOutFile=NULL);

		// get specific point
		virtual unsigned int GetData(int iX, int iY) const;
		virtual double GetDoubleData(int iX, int iY) const;
		virtual unsigned int GetIntData(int iX, int iY) const;

		// same as above, but return 0 if outside ROI (if ROI is used)
		unsigned int GetDataInsideROI(int iX, int iY) const;

		// get pointer to internal memory
		unsigned int* GetRawData(void);

		// total number of counts (inside ROI, if used)
		unsigned int GetCounts() const;

		const PadConfig& GetPadConfig() const;

		Roi& GetRoi();
		void UseRoi(bool bUseRoi=true);
		bool GetUseRoi() const;
};


//==============================================================================

/*
 * class for temporary images generated by some methods of the
 * TofImage class
 */
class TmpImage : public BasicImage
{
	friend class PadImage;
	friend class TofImage;

  protected:
	// image dimensions
	int m_iW, m_iH;

	//--------------------------------------------------------------------------
	// only one of the following pointers is actually used (the other has
	// to be NULL)

	// pointer to array for counts data
	unsigned int* m_puiDaten;
	// pointer to array for contrast/phase data
	double* m_pdDaten;
	//--------------------------------------------------------------------------

	// lower & upper bound values
	double m_dMin, m_dMax;

  public:
	// create EMPTY TmpImage without allocation any memory etc.
	// (which done externally)
	TmpImage();

	// create TmpImage from other TmpImage; does allocate memory
	TmpImage(const TmpImage& tmp);

	virtual ~TmpImage();

	// clean up
	void Clear(void);

	// get data point (if "wrong" type is requested, the return value is cast)
	virtual double GetData(int iX, int iY) const;
	virtual unsigned int GetIntData(int iX, int iY) const;
	virtual double GetDoubleData(int iX, int iY) const;

	virtual int GetWidth() const;
	virtual int GetHeight() const;

	// calculate lower & upper bound values
	void UpdateRange();

	virtual int GetIntMin(void) const;
	virtual int GetIntMax(void) const;
	virtual double GetDoubleMin(void) const;
	virtual double GetDoubleMax(void) const;

	// write XML representation of image
	bool WriteXML(const char* pcFileName) const;

	// create TmpImage from PAD image
	void ConvertPAD(PadImage* pPad);

	// adds another TmpImage to this one
	void Add(const TmpImage& tmp);
};


//==============================================================================

/*
 * class for temporary graph data generated by some methods of the
 * TofImage class
 */
class TmpGraph
{
  friend class TofImage;

  protected:
	// # of data points
	int m_iW;

	// pointer to data array
	unsigned int* m_puiDaten;

  public:
	// create empty graph (does not allocate memory)
	TmpGraph();
	virtual ~TmpGraph();

	// fit a sinus function to the data points
	// return value: fit successful?
	bool FitSinus(double &dPhase, double &dScale,
				  double &dAmp, double &dOffs) const;

	//--------------------------------------------------------------------------
	// getter
	unsigned int GetData(int iX) const;
	int GetWidth(void) const;
	int GetMin() const;
	int GetMax() const;
	//--------------------------------------------------------------------------

	// is sum of data points < iTotal?
	bool IsLowerThan(int iTotal) const;
};


//==============================================================================

/*
 * TOF
 * container representing a TOF image
 * (corresponds to the "TOF" measurement type in the server & HardwareLib)
 */
class TofImage
{
	protected:
		// pointer to data array (format depends on compression used)
		unsigned int *m_puiDaten;
		bool m_bPseudoCompressed;

		// TOF data stored in external memory which needs no management,
		// i.e. allocation & freeing?
		bool m_bExternalMem;

		TofConfig m_config;

		Roi m_roi;
		bool m_bUseRoi;

	public:
		//----------------------------------------------------------------------
		// "internal" methods => use corresponding method below
		// TODO: rename method
		void GetROI(int iStartX, int iEndX, int iStartY, int iEndY, int iFoil,
					int iTimechannel, TmpImage *pImg) const;
		void GetGraph(int iStartX, int iEndX, int iStartY, int iEndY,
					  int iFoil, TmpGraph* pGraph) const;
		void GetGraph(int iFoil, TmpGraph* pGraph) const;
		void GetTotalGraph(int iStartX, int iEndX, int iStartY, int iEndY,
						   double dPhaseShift ,TmpGraph* pGraph) const;
		void GetOverview(TmpImage *pImg) const;
		void GetPhaseGraph(int iFoil, TmpImage *pImg, bool bInDeg=true) const;
		void GetContrastGraph(int iFoil, TmpImage *pImg) const;

		void AddFoils(int iBits, int iChannelBits/*=0xffffffff*/,
					  TmpImage *pImg) const;
		void AddFoils(const bool *pbChannels, TmpImage *pImg) const;
		void AddPhases(const bool *pbFoils, TmpImage *pImg) const;
		void AddContrasts(const bool *pbFoils, TmpImage *pImg) const;
		//----------------------------------------------------------------------

		const TofConfig& GetTofConfig() const;

		Roi& GetRoi();
		void UseRoi(bool bUseRoi=true);
		bool GetUseRoi() const;

	public:
		TofImage(const char *pcFileName=NULL,
				 int iCompression=TOF_COMPRESSION_USEGLOBCONFIG,
				 bool bExternalMem=false, const TofConfig* conf=0);

		virtual ~TofImage();

		// set pointer to external memory (if bExternalMem==true)
		void SetExternalMem(void* pvDaten);

		int GetTofSize() const;
		void Clear();
		int GetCompressionMethod() const;
		void SetCompressionMethod(int iComp);

		// get specific count value
		unsigned int GetData(int iFoil, int iTimechannel, int iX, int iY) const;
		unsigned int GetData(int iImage, int iX, int iY) const;

		// same as above, but return 0 if outside ROI (if ROI is used)
		unsigned int GetDataInsideROI(int iFoil, int iTimechannel,
									  int iX, int iY) const;
		unsigned int GetDataInsideROI(int iImage, int iX, int iY) const;

		// get raw pointer to data array
		unsigned int* GetRawData(void) const;

		int LoadFile(const char *pcFileName);

		// uiBufLen: # of ints (NOT # of bytes)
		int LoadMem(const unsigned int *puiBuf, unsigned int uiBufLen);

		// total number of counts (inside ROI, if used)
		unsigned int GetCounts() const;

		//----------------------------------------------------------------------
		// copy ROI into new temporary image
		// TODO: rename method to avoid confusion with new ROI stuff
		TmpImage GetROI(int iStartX, int iEndX, int iStartY, int iEndY,
						int iFoil, int iTimechannel) const;

		// get graph for counts vs. time channels
		TmpGraph GetGraph(int iStartX, int iEndX, int iStartY, int iEndY,
						  int iFoil) const;

		TmpGraph GetGraph(int iFoil) const;

		// TODO
		TmpGraph GetTotalGraph(int iStartX, int iEndX, int iStartY, int iEndY,
							   double dPhaseShift) const;

		// get overview image (summing all individual images in TOF)
		TmpImage GetOverview() const;

		// phase image
		TmpImage GetPhaseGraph(int iFoil, bool bInDeg=true) const;

		// contrast image
		TmpImage GetContrastGraph(int iFoil) const;

		// sum foils/phases/contrasts marked in respective bool array
		TmpImage AddFoils(const bool *pbChannels) const;
		TmpImage AddPhases(const bool *pbFoils) const;
		TmpImage AddContrasts(const bool *pbFoils) const;
		//----------------------------------------------------------------------
};

#endif
